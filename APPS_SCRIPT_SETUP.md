# Googleスプレッドシート連携セットアップガイド

このガイドでは、請求書ジェネレーターとGoogleスプレッドシートを連携させる方法を説明します。

## 🎯 この設定により実現できること

- ✅ **ログイン不要**でGoogleスプレッドシートに自動保存
- ✅ ブラウザのデータとスプレッドシートの両方に保存
- ✅ 複数のデバイスからデータにアクセス可能
- ✅ Excelで編集・分析可能

## 📋 セットアップ手順

### ステップ1: Googleスプレッドシートを作成

1. [Google Sheets](https://sheets.google.com/) を開く
2. 「新しいスプレッドシートを作成」をクリック
3. スプレッドシートの名前を「請求書データ」に変更（任意）

### ステップ2: Apps Script を開く

1. スプレッドシートのメニューから **拡張機能** → **Apps Script** をクリック
2. 新しいタブでApps Scriptエディタが開きます

### ステップ3: コードを貼り付け

1. エディタに表示されているデフォルトのコード（`function myFunction() {}`）を**すべて削除**
2. プロジェクトフォルダの **`AppsScript.gs`** ファイルを開く
3. **すべてのコードをコピー**
4. Apps Scriptエディタに**貼り付け**
5. 左上の**保存アイコン（💾）** または `Ctrl+S` / `Cmd+S` で保存

### ステップ4: デプロイ（公開）

1. Apps Scriptエディタの右上の **「デプロイ」** → **「新しいデプロイ」** をクリック

2. **「種類の選択」** の歯車アイコンをクリック → **「ウェブアプリ」** を選択

3. 以下のように設定：
   - **説明**: `請求書ジェネレーター API` （任意）
   - **次のユーザーとして実行**: **自分（あなたのメールアドレス）**
   - **アクセスできるユーザー**: **全員** ⚠️ 重要！

4. **「デプロイ」** ボタンをクリック

5. 初回のみ、アクセス許可の確認が表示されます：
   - 「アクセスを承認」をクリック
   - Googleアカウントを選択
   - **「このアプリは Google で確認されていません」** という警告が表示される場合：
     - 左下の **「詳細」** をクリック
     - **「（プロジェクト名）に移動（安全ではないページ）」** をクリック
     - **「許可」** をクリック

6. **「ウェブアプリ URL」** が表示されます
   - この URL を**コピー**してください
   - 形式: `https://script.google.com/macros/s/XXXXX.../exec`

### ステップ5: アプリに URL を設定

1. 請求書ジェネレーターの **「設定」** タブを開く

2. **「Googleスプレッドシート連携」** セクションを見つける

3. **「Apps Script Web App URL」** の入力欄に、コピーした URL を貼り付け

4. **「設定を保存」** をクリック

### ステップ6: 動作確認

1. **「ホーム」** タブに戻る

2. **「新規作成」** で請求書を作成

3. 顧客情報と品目を入力して **「保存」** をクリック

4. Googleスプレッドシートを開いて確認：
   - **「請求書一覧」** シートに請求書データが追加されているはず
   - **「品目詳細」** シートに品目データが追加されているはず

✅ データが表示されていれば、連携成功です！

---

## 🔧 よくある質問

### Q1: 「このアプリは Google で確認されていません」と表示される

**A:** 自分で作成したApps Scriptなので正常です。「詳細」→「（プロジェクト名）に移動」をクリックして続行してください。

### Q2: データがスプレッドシートに保存されない

**確認ポイント：**

1. **URL が正しいか確認**
   - `https://script.google.com/macros/s/.../exec` で終わっているか
   - 余計な空白が入っていないか

2. **デプロイ設定を確認**
   - 「アクセスできるユーザー」が **「全員」** になっているか
   - 再度デプロイして新しい URL を取得してみる

3. **ブラウザのコンソールを確認**
   - F12 を押してコンソールを開く
   - エラーメッセージがないか確認

### Q3: 複数のデバイスで使いたい

**A:** 可能です。各デバイスで同じ Apps Script URL を設定すれば、すべてのデバイスから同じスプレッドシートに保存されます。

### Q4: URLを変更したい / 削除したい

**A:** 設定画面で URL を変更または空欄にして「設定を保存」してください。

### Q5: データのバックアップは？

**A:** 以下の方法でバックアップできます：
- Googleスプレッドシートからダウンロード（ファイル → ダウンロード → Excel）
- アプリの「Excelエクスポート」ボタン
- アプリの「CSVエクスポート」ボタン

---

## ⚙️ 高度な設定

### デプロイの更新

Apps Script のコードを変更した場合：

1. Apps Script エディタで **「デプロイ」** → **「デプロイを管理」** をクリック
2. 鉛筆アイコン（編集）をクリック
3. **「バージョン」** を **「新バージョン」** に変更
4. **「デプロイ」** をクリック

URL は変わりません。

### セキュリティを強化したい

Apps Scriptに簡単な認証を追加する方法：

```javascript
// doPost関数の最初に追加
const SECRET_KEY = 'your-secret-key-here'; // 秘密のキーを設定

if (data.secretKey !== SECRET_KEY) {
  return ContentService.createTextOutput(JSON.stringify({
    success: false,
    error: 'Unauthorized'
  })).setMimeType(ContentService.MimeType.JSON);
}
```

アプリ側でも秘密キーを送信するようにコードを修正してください。

---

## 🆘 トラブルシューティング

### エラー: "Exception: サービスを呼び出せません"

**原因:** Apps Scriptの実行権限がない

**解決方法:**
1. Apps Script エディタで **「実行」** ボタンをクリック
2. 初期化関数を選択して実行
3. 権限を承認

### エラー: "ReferenceError: ContentService is not defined"

**原因:** コードが正しく貼り付けられていない

**解決方法:**
1. AppsScript.gs ファイルの**全コード**をコピー
2. Apps Scriptエディタの**すべて**を削除してから貼り付け

### データが重複して保存される

**原因:** 同じ請求書番号で複数回保存している

**解決方法:**
- 請求書番号が一意であることを確認
- スプレッドシートで重複行を手動で削除

---

## 📚 参考情報

- [Google Apps Script 公式ドキュメント](https://developers.google.com/apps-script)
- [スプレッドシートサービス](https://developers.google.com/apps-script/reference/spreadsheet)
- [Web Apps](https://developers.google.com/apps-script/guides/web)

---

## 💡 ヒント

- **定期的なバックアップ**: 月に一度は Excel/CSV でエクスポートしてバックアップを取りましょう
- **スプレッドシートの共有**: 他のユーザーと共有すれば、複数人でデータを確認できます
- **データ分析**: スプレッドシートの関数やグラフ機能で売上分析ができます

---

**セットアップが完了したら、ログイン不要でスプレッドシートに自動保存されるようになります！**
